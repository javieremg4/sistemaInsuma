<?php
    session_start();
    if(!(isset($_SESSION['usuario']))){
        header("location:../HTML/inicioUsuario.html");
    }
    if(!(isset($_POST['apemat'],$_POST['apemat'],$_POST['nombre']))){
        header("location:../HTML/buscarAlumno.html");
    }
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Ver Alumnos</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <!--Estilos-->
    <link rel="shortcut icon" href="../Imagenes/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../Estilos/datos.css">

</head>
<body>
    <?php
        include("../PHP/conexion.php");
        $apepat = $_POST["apepat"];
        $apemat = $_POST["apemat"];
        $nombre = $_POST["nombre"];
        //Valoración de los parámetros para realizar la búsqueda
        if($apepat==""){
            if($apemat==""){
                //echo "Búsqueda por Nombre";
                $consulta = "SELECT * FROM datos WHERE nombre='$nombre'";
            }else{
                if($nombre==""){
                    //echo "Búsqueda por Apellido Materno";
                    $consulta = "SELECT * FROM datos WHERE apemat='$apemat'";
                }else{
                    //echo "Búsqueda por Nombre y Apellido Materno";
                    $consulta = "SELECT * FROM datos WHERE nombre='$nombre' AND apemat='$apemat'";
                }
            }
        }else{
            if($apemat==""){
                if($nombre==""){
                    //echo "Búsqueda por Apellido Paterno";
                    $consulta = "SELECT * FROM datos WHERE apepat='$apepat'";
                }else{
                    //echo "Búsqueda por Nombre y Apellido Paterno";
                    $consulta = "SELECT * FROM datos WHERE nombre='$nombre' AND apepat='$apepat'";
                }
            }else{
                if($nombre==""){
                    //echo "Búsqueda por Apellido Paterno y Apellido Materno";
                    $consulta = "SELECT * FROM datos WHERE apemat='$apemat' AND apepat='$apepat'";
                }else{
                    //echo "Búsqueda por Nombre, Apellido Paterno y Apellido Materno";
                    $consulta = "SELECT * FROM datos WHERE nombre='$nombre' AND apemat='$apemat' AND apepat='$apepat'";
                    
                }
            }
        }
        $buscarAlumnos = mysqli_query($conexion,$consulta);
        if(mysqli_num_rows($buscarAlumnos)>0){
            echo "Se encontraron ".mysqli_num_rows($buscarAlumnos)." resultados<hr>";
        while($info=mysqli_fetch_array($buscarAlumnos)){
            ?>
    <div class="div-datos">
            <?php
                if(($info['foto']!=null || $info['foto']!="") && !file_exists($info['foto'])){
                    $idAl=$info['clave'];
                    mysqli_query($conexion,"UPDATE datos SET foto=null WHERE clave='$idAl'");
                    $info['foto']=null;
                }
                if($info['foto']==null || $info['foto']==""){
                    echo "<img class='foto' src='../Imagenes/sinFoto.jpg' />";
                }else{
                    $foto = $info['foto'];
                    echo "<img class='foto' src='".$foto."' />";
                }
    ?>
        <div class="datos">
    <?php
            echo "<b>No. Control: </b>";
            $conClave = $info['clave'];
            $conClave = mysqli_query($conexion,"SELECT numControl FROM altas WHERE clave='$conClave'");
            if(mysqli_num_rows($conClave)){
                $conClave = mysqli_fetch_array($conClave);
                if($conClave['numControl']!=NULL &&  $conClave['numControl']!=""){
                    echo $conClave['numControl']."<br>";
                }else{
                    echo "S/N<br>";  
                }
            }
            echo "<b>CURP: </b>".$info['curp']."<br>";
            echo "<b>Género: </b>".$info['genero']."<br>";
            echo "<b>Nombre Completo: </b>".$info['apepat']." ".$info['apemat']." ".$info['nombre']."<br>";                 
            echo "<b>Fec. Nacimiento: </b>".$info['fnac']."<br>";
    ?>
        </div>
        <div class="datos">
            <div class="h100">
        <?php
                echo "<b>Dirección: </b>".$info['direccion']."<br>";
                echo "<b>Tel. Alumno: </b>".$info['telalumno']."<br>";
                echo "<b>Tel. Casa: </b>".$info['telcasa']."<br>";
        ?>
            </div>
            <div class="h50" style=" display: flex; padding: 0; align-items: center;">
            <?php
                $conBaja = $info['clave'];
                $conBaja = mysqli_query($conexion,"SELECT clave FROM bajas WHERE clave='$conBaja'");
                if(mysqli_num_rows($conBaja)){
                    echo "<img src='../Imagenes/alert.jpg' style='height: 24px; margin-right: 7.5px;'>";
                    echo "<span style='font-size: 20px; color: red;'><b>Baja</b></span>";
                }
            ?>
            </div>
        </div>
        <div class="div-links">
            <div class="btnAl adp" onclick="sesionId('adp',<?php echo $info['clave']; ?>)">Actualizar Datos Personales</div>
            <div class="btnAl ade" onclick="sesionId('ade',<?php echo $info['clave']; ?>)">Actualizar Datos Escolares</div>
            <div class="btnAl baja" onclick="sesionId('ddb',<?php echo $info['clave']; ?>)">Dar de Baja o Eliminar Baja</div>
        </div>

    </div>
    <?php
        }
        }else{
            echo "No se encontró nada <hr>";
        }
    ?>
    <script type="text/javascript">
        function sesionId(op,id){
            window.location.href="../PHP/testId.php?"+op+"="+id;
        }
    </script>
</body>
</html>
